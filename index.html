<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mostri GO - Stability Edition</title>
    <style>
        :root {
            --primary: #4facfe; --secondary: #00f2fe;
            --yellow: #ffcb05; --blue: #3c5aa6; --green: #2ed573; --red: #ff4757;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', Roboto, sans-serif;
            overflow: hidden; background-color: #f0f0f0; touch-action: none;
        }

        /* --- UI GIOCO --- */
        #game-container { display: none; width: 100%; height: 100%; position: relative; background: #e0e0e0; }

        .top-btn {
            position: absolute; top: 20px; z-index: 500; 
            background: white; border: 3px solid var(--blue);
            border-radius: 50%; width: 55px; height: 55px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer;
        }
        #camera-toggle-btn { left: 20px; }
        #backpack-btn { right: 20px; }

        #camera-window {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; border-radius: 50%; border: 8px solid white;
            overflow: hidden; background-color: #2f3542;
            background-image: url('https://img.freepik.com/free-vector/landscape-with-green-grass-blue-sky_1048-9366.jpg');
            background-size: cover; background-position: center;
        }

        #camera-stream { width: 100%; height: 100%; object-fit: cover; opacity: 0; position: absolute; }

        #radar-container {
            position: absolute; top:0; left:0; width: 100%; height: 100%;
            background: rgba(47, 53, 66, 0.8); z-index: 5; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }

        /* --- ANIMAZIONE LOTTA --- */
        #target-monster { 
            position: absolute; width: 150px; height: 150px; 
            top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 10; object-fit: contain; pointer-events: none;
            display: none; transition: opacity 0.3s;
        }

        @keyframes fighting {
            0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            25% { transform: translate(-48%, -52%) scale(1.05) rotate(3deg); }
            50% { transform: translate(-52%, -48%) scale(0.95) rotate(-3deg); }
            75% { transform: translate(-49%, -51%) scale(1.02) rotate(2deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }
        .monster-moving { animation: fighting 2s ease-in-out infinite; }
        
        #pokeball { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 70px; z-index: 20; cursor: pointer; display: none; }

        .ball-throwing { transition: transform 0.6s cubic-bezier(0.1, 0.5, 0.5, 1) !important; }
        .ball-shake-center { animation: slowShake 1.2s ease-in-out infinite; top: 50% !important; bottom: auto !important; }
        @keyframes slowShake {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-20deg); }
            75% { transform: translate(-50%, -50%) rotate(20deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }

        /* --- MODALI --- */
        .modal {
            display: none; position: fixed; z-index: 2000; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95%; height: 85%; background: white; border-radius: 20px; border: 4px solid var(--blue);
            padding: 15px; box-sizing: border-box; overflow-y: auto;
        }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: #f1f2f6; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; align-items: center; border: 1px solid #ddd; }
        .card img { width: 70px; height: 70px; object-fit: contain; }
        .silhouette { filter: brightness(0); opacity: 0.6; }
        .type-tag { font-size: 0.55rem; padding: 2px 5px; border-radius: 4px; color: white; margin: 1px; display: inline-block; text-transform: uppercase; }
        .t-erba { background: #78C850; } .t-fuoco { background: #F08030; }
        .t-acqua { background: #6890F0; } .t-elettro { background: #F8D030; color: #000; }
        .t-psico { background: #F85888; } .t-buio { background: #705848; }
        .t-roccia { background: #B8A038; } .t-spettro { background: #705898; }
        .captured-count { font-size: 0.65rem; color: #666; font-weight: bold; margin-top: 5px; }

        .btn-play { padding:15px 50px; border-radius:30px; border:none; background:var(--yellow); color:var(--blue); font-weight:bold; font-size:1.5rem; cursor:pointer; }
    </style>
</head>
<body>

    <audio id="audio-gotcha" src="https://www.myinstants.com/media/sounds/pokemon-gotcha.mp3" preload="auto"></audio>

    <div id="menu-iniziale" style="position:fixed; width:100%; height:100%; background:var(--primary); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; text-align:center;">
        <h1 style="font-size:3rem; margin-bottom:20px;">MOSTRI GO</h1>
        <button class="btn-play" onclick="initGame()">GIOCA</button>
        <p style="margin-top:20px; font-size:0.9rem; opacity:0.8;">Radar RPG pronto all'azione!</p>
    </div>

    <div id="game-container">
        <div id="camera-toggle-btn" class="top-btn" onclick="toggleCamera()">ðŸ“·</div>
        <div id="backpack-btn" class="top-btn" onclick="toggleCollection()">ðŸŽ’</div>
        
        <div id="camera-window">
            <video id="camera-stream" autoplay playsinline></video>
            <div id="radar-container">
                <div style="width:70px; height:70px; border:3px solid var(--green); border-radius:50%; animation: pulse 2s infinite;"></div>
                <p style="margin-top:10px; letter-spacing: 2px;">RICERCA IN CORSO...</p>
            </div>
            <img id="target-monster" src="" class="monster-moving">
        </div>
        <img id="pokeball" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png">
    </div>

    <div id="collection-modal" class="modal">
        <div class="tab-bar">
            <button id="tab-squad" class="tab-btn tab-active" onclick="switchTab('squad')">SQUADRA</button>
            <button id="tab-dex" class="tab-btn" onclick="switchTab('dex')">PAGINE DEX</button>
        </div>
        <div id="squad-view" class="grid"></div>
        <div id="dex-view" class="grid" style="display:none;"></div>
        <button onclick="toggleCollection()" style="width:100%; margin-top:15px; padding:12px; background:#333; color:white; border:none; border-radius:12px;">CHIUDI</button>
    </div>

    <script>
        const REPO_BASE_URL = "https://raw.githubusercontent.com/Ajbajibanpm/DispensaMostri/main/";
        
        const DB_SPECIE = {
            1: { n: "Chtulino", t: ["acqua", "buio"], hp: [40,60], fz: [30,50], r: 20 },
            2: { n: "Fiammifero", t: ["fuoco"], hp: [30,55], fz: [50,75], r: 40 },
            3: { n: "Gocciolo", t: ["acqua"], hp: [50,85], fz: [20,40], r: 50 },
            4: { n: "Fogliasaggia", t: ["erba"], hp: [60,95], fz: [30,50], r: 40 },
            5: { n: "Elettrogatto", t: ["elettro"], hp: [35,55], fz: [60,85], r: 30 },
            6: { n: "Rocciolo", t: ["roccia"], hp: [80,120], fz: [40,65], r: 35 },
            7: { n: "Ombratesta", t: ["spettro", "buio"], hp: [40,60], fz: [65,95], r: 15 },
            8: { n: "Gelone", t: ["acqua"], hp: [55,80], fz: [45,70], r: 30 },
            9: { n: "Nuvola", t: ["psico"], hp: [45,70], fz: [50,80], r: 25 },
            10: { n: "Velenino", t: ["erba"], hp: [40,75], fz: [45,70], r: 40 },
            11: { n: "Draconiglio", t: ["erba", "psico"], hp: [70,110], fz: [65,90], r: 10 },
            12: { n: "Sabbioso", t: ["roccia"], hp: [60,90], fz: [45,70], r: 35 },
            13: { n: "Ferraglia", t: ["roccia"], hp: [90,145], fz: [35,60], r: 20 },
            14: { n: "Psicocchio", t: ["psico"], hp: [50,75], fz: [75,105], r: 15 },
            15: { n: "Insettoide", t: ["erba"], hp: [40,65], fz: [40,65], r: 45 },
            16: { n: "Alieno", t: ["psico", "buio"], hp: [65,100], fz: [70,100], r: 10 },
            17: { n: "Baffone", t: ["acqua"], hp: [75,115], fz: [30,55], r: 30 },
            18: { n: "Spettroide", t: ["spettro"], hp: [35,55], fz: [85,115], r: 15 },
            19: { n: "Gigaslurp", t: ["acqua", "erba"], hp: [110,160], fz: [45,65], r: 5 }
        };

        const NOMI_M = ["Claudio", "Ambrogio", "Kevin", "Gennaro", "Ugo", "Renato", "Loris", "Tiziano"];
        const NOMI_F = ["Claudia", "Mariantonia", "Giuditta", "Enrica", "Sonia", "Tea", "Ivana", "Beatrice"];

        let squadra = JSON.parse(localStorage.getItem('mostri_squadra')) || [];
        // Pokedex ora salva il numero di catture: { id: numero }
        let pokedex = JSON.parse(localStorage.getItem('mostri_dex_counts')) || {};
        let currentMonsterId = null;
        let videoStream = null;
        let isAR = true;
        let isSearching = false; // Stato per evitare spawn multipli

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

        async function initGame() {
            if ("Notification" in window) { Notification.requestPermission(); }
            document.getElementById('menu-iniziale').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            startSearchPhase();
        }

        function startSearchPhase() {
            if (squadra.length >= 6) {
                alert("Squadra piena! Libera un mostro per continuare la ricerca.");
                return;
            }
            if (isSearching) return; // Evita di far partire due timer

            isSearching = true;
            document.getElementById('radar-container').style.display = 'flex';
            document.getElementById('target-monster').style.display = 'none';
            document.getElementById('pokeball').style.display = 'none';

            // Il timer parte qui e non viene richiamato finchÃ© non finisce la cattura
            setTimeout(notifyArrival, (Math.floor(Math.random() * 15) + 10) * 1000);
        }

        function notifyArrival() {
            isSearching = false; // La ricerca Ã¨ finita, ora siamo in fase cattura
            let pool = [];
            for(let id in DB_SPECIE) { for(let i=0; i<DB_SPECIE[id].r; i++) pool.push(id); }
            currentMonsterId = pool[Math.floor(Math.random() * pool.length)];

            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'SHOW_NOTIFICATION',
                    title: 'Gotcha!',
                    body: 'Un mostro Ã¨ apparso vicino a te!'
                });
            }

            try {
                document.getElementById('audio-gotcha').play();
                if (window.navigator.vibrate) window.navigator.vibrate([500, 200, 500]);
            } catch(e) {}

            document.getElementById('radar-container').style.display = 'none';
            const monsterImg = document.getElementById('target-monster');
            monsterImg.src = `${REPO_BASE_URL}${currentMonsterId}.png`;
            monsterImg.style.display = 'block';
            monsterImg.style.opacity = '1';
            document.getElementById('pokeball').style.display = 'block';
            if(isAR) startCamera();
        }

        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('camera-stream').srcObject = videoStream;
                document.getElementById('camera-stream').style.opacity = "1";
            } catch (e) {}
        }

        function stopCamera() { if (videoStream) videoStream.getTracks().forEach(t => t.stop()); document.getElementById('camera-stream').style.opacity = "0"; videoStream = null; }
        function toggleCamera() { if(videoStream) { stopCamera(); isAR = false; } else startCamera(); }

        function throwBall() {
            const ball = document.getElementById('pokeball');
            if (ball.classList.contains('ball-throwing')) return;
            ball.classList.add('ball-throwing');
            ball.style.transform = `translateX(-50%) translateY(-230px) scale(0.6)`;

            setTimeout(() => {
                document.getElementById('target-monster').style.opacity = '0';
                ball.classList.remove('ball-throwing');
                ball.classList.add('ball-shake-center');
                let shakes = 0;
                const interval = setInterval(() => {
                    shakes++;
                    if (Math.random() > 0.8) { clearInterval(interval); failCapture(); }
                    else if (shakes === 3) { clearInterval(interval); completeCapture(); }
                }, 1200);
            }, 600);
        }

        function failCapture() {
            const ball = document.getElementById('pokeball');
            ball.classList.remove('ball-shake-center');
            ball.style.transform = `translateX(-50%) translateY(0)`;
            document.getElementById('target-monster').style.opacity = '1';
        }

        function completeCapture() {
            const ball = document.getElementById('pokeball');
            ball.classList.remove('ball-shake-center');
            ball.style.transform = `translateX(-50%) translateY(0)`;
            ball.style.display = 'none';

            const sp = DB_SPECIE[currentMonsterId];
            const isM = Math.random() > 0.5;
            const nuovo = {
                uid: Date.now(), id: currentMonsterId, specie: sp.n,
                soprannome: isM ? NOMI_M[Math.floor(Math.random()*NOMI_M.length)] : NOMI_F[Math.floor(Math.random()*NOMI_F.length)],
                sesso: isM ? 'M' : 'F',
                hp: Math.floor(Math.random() * (sp.hp[1]-sp.hp[0]+1)) + sp.hp[0],
                fz: Math.floor(Math.random() * (sp.fz[1]-sp.fz[0]+1)) + sp.fz[0],
                tipi: sp.t
            };

            // Aggiorna contatore Dex
            pokedex[currentMonsterId] = (pokedex[currentMonsterId] || 0) + 1;
            
            squadra.push(nuovo);
            localStorage.setItem('mostri_squadra', JSON.stringify(squadra));
            localStorage.setItem('mostri_dex_counts', JSON.stringify(pokedex));
            
            // IMPORTANTE: Solo dopo la cattura facciamo ripartire la ricerca se c'Ã¨ spazio
            if (squadra.length >= 6) {
                toggleCollection('squad');
            } else {
                startSearchPhase();
            }
        }

        function releaseMonster(uid, nome) {
            if(confirm(`Liberare ${nome}?`)) {
                const eraPieno = squadra.length >= 6;
                squadra = squadra.filter(m => m.uid !== uid);
                localStorage.setItem('mostri_squadra', JSON.stringify(squadra));
                updateViews();
                
                // Se abbiamo liberato spazio, facciamo ripartire la ricerca
                if(eraPieno && squadra.length < 6) {
                    toggleCollection(); // Chiude il modale
                    startSearchPhase();
                }
            }
        }

        function updateViews() {
            document.getElementById('squad-view').innerHTML = squadra.map(m => `
                <div class="card">
                    <img src="${REPO_BASE_URL}${m.id}.png">
                    <strong>${m.soprannome}</strong>
                    <div style="font-size:0.7rem;">${m.specie} <span style="color:${m.sesso==='M'?'#0984e3':'#fd79a8'}">${m.sesso==='M'?'â™‚':'â™€'}</span></div>
                    <div>${m.tipi.map(t => `<span class="type-tag t-${t}">${t}</span>`).join('')}</div>
                    <div style="font-size:0.7rem;">HP: ${m.hp} | FZ: ${m.fz}</div>
                    <button style="background:var(--red); color:white; border:none; border-radius:8px; width:100%; margin-top:5px; padding:5px;" onclick="releaseMonster(${m.uid}, '${m.soprannome}')">LIBERA</button>
                </div>
            `).join('');

            document.getElementById('dex-view').innerHTML = Object.keys(DB_SPECIE).map(id => {
                const s = DB_SPECIE[id]; 
                const catturati = pokedex[id] || 0;
                return `
                    <div class="card">
                        <img src="${REPO_BASE_URL}${id}.png" class="${catturati > 0 ? '' : 'silhouette'}">
                        <strong>${catturati > 0 ? s.n : '???'}</strong>
                        <div class="captured-count">${catturati > 0 ? 'Catturati: ' + catturati : 'Mai visto'}</div>
                    </div>
                `;
            }).join('');
        }

        function switchTab(tab) {
            document.getElementById('squad-view').style.display = tab === 'squad' ? 'grid' : 'none';
            document.getElementById('dex-view').style.display = tab === 'dex' ? 'grid' : 'none';
            document.getElementById('tab-squad').className = 'tab-btn ' + (tab === 'squad' ? 'tab-active' : '');
            document.getElementById('tab-dex').className = 'tab-btn ' + (tab === 'dex' ? 'tab-active' : '');
            updateViews();
        }

        function toggleCollection(tab) {
            const m = document.getElementById('collection-modal');
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
            if(tab) switchTab(tab); else updateViews();
        }

        document.getElementById('pokeball').onclick = throwBall;
    </script>
</body>
</html>
